<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/Home.css') }}">
  <title>Elherafeen Store | Cart</title>
</head>
<body>
  <main>

    <header>
      <div class="container">
        <div class="top-row">
          <div class="logo">
            <img src="{{ url_for('static', filename='images/icons/ELHERAFEEN LOGO BLACK.png') }}" alt="ELHERAFEEN">
          </div>

          <div class="search-bar">
            <input type="search" placeholder="Search for parts">
          </div>

          <div class="icons">
            <button type="button" class="icon-btn">❤</button>
            <a href="{{ url_for('cart.cart') }}">Cart</a>
            <a class="btn auth" href="/Elherafeen/templates/login.html">Login</a>
          </div>
        </div>

        <nav class="sections">
          <a href="home.html">Home</a>
          <a href="#">Section 2</a>
          <a href="#">Section 3</a>
          <a href="#">Section 4</a>
          <a href="#">Section 5</a>
        </nav>
      </div>
    </header>

    <section class="cart-page">
      <div class="container cart-layout">

        <div class="cart-header-text">
          <h1>Your Cart</h1>
          <p>Review your selected parts before checkout.</p>
        </div>

        <div class="cart-content">

          <div class="cart-items">
            {% if cart_items %}
              {% for item in cart_items %}
                {% set p = item.product %}
                <article class="cart-item">
                  <div class="cart-item-media">
                    <img
                      src="{% if p.images and p.images[0] != 'placeholder' %}{{ p.images[0] }}{% else %}{{ url_for('static', filename='images/products/placeholder.jpg') }}{% endif %}"
                      alt="{{ p.name }}"
                    >
                  </div>

                  <div class="cart-item-body">
                    <div class="cart-item-main">
                      <p class="cart-item-brand">{{ p.brand }}</p>
                      <h2 class="cart-item-title">{{ p.name }}</h2>
                      <p class="cart-item-meta">OEM: {{ p.oem }}</p>
                    </div>

                    <div class="cart-item-controls">
                      <div class="cart-qty">
                        <label for="qty-{{ loop.index }}">Qty</label>
                        <div class="cart-qty-input">
                          <button
                            type="button"
                            class="qty-btn qty-minus"
                            data-oem="{{ item.oem }}"
                            data-direction="minus"
                          >-</button>
                          <input
                            id="qty-{{ loop.index }}"
                            type="number"
                            min="1"
                            value="{{ item.quantity }}"
                          >
                          <button
                            type="button"
                            class="qty-btn qty-plus"
                            data-oem="{{ item.oem }}"
                            data-direction="plus"
                          >+</button>
                        </div>
                      </div>

                      <div class="cart-prices">
                        <span class="cart-price">{{ p.price }} {{ currency }}</span>
                        <span class="cart-subtotal">{{ item.line_total }} {{ currency }}</span>
                      </div>

                      <button
                        type="button"
                        class="cart-remove-btn"
                        data-oem="{{ item.oem }}"
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                </article>
              {% endfor %}
            {% else %}
              <div class="cart-empty">
                <div class="cart-empty-card">
                  <h2>Your cart is empty</h2>
                  <p>Looks like you haven’t added any parts yet.</p>
                  <a href="products.html" class="btn cart-empty-btn">Browse Products →</a>
                </div>
              </div>
            {% endif %}
          </div>

          <aside class="cart-summary">
            <h2>Order Summary</h2>

            <div class="cart-summary-row">
              <span>Items ({{ total_quantity }})</span>
              <span>{{ subtotal }} {{ currency }}</span>
            </div>

            <div class="cart-summary-row">
              <span>Estimated Shipping</span>
              <span>{{ shipping }} {{ currency }}</span>
            </div>

            <div class="cart-summary-row">
              <span>Tax</span>
              <span>{{ tax }} {{ currency }}</span>
            </div>

            <hr>

            <div class="cart-summary-row cart-summary-total">
              <span>Total</span>
              <span>{{ total }} {{ currency }}</span>
            </div>

            <a href="#" class="btn cart-checkout-btn">Proceed to Checkout →</a>
            <a href="products.html" class="cart-continue-link">← Continue Shopping</a>
          </aside>
        </div> 

      </div>
    </section>

  </main>

  <!-- CART JS FOR BUTTONS -->
  <script>
    const updateUrl = "{{ url_for('cart.update_cart_quantity') }}";
    const removeUrl = "{{ url_for('cart.remove_from_cart') }}";

    // + / -
document.querySelectorAll(".qty-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const direction = btn.dataset.direction;
    const oem = btn.dataset.oem;

    const qtyContainer = btn.closest(".cart-qty-input");
    const input = qtyContainer.querySelector("input");

    let currentQty = parseInt(input.value, 10) || 1;
    let newQty = currentQty;

    if (direction === "plus") {
      newQty = currentQty + 1;
    } else if (direction === "minus") {
      newQty = Math.max(1, currentQty - 1);
    }

    input.value = newQty;

    try {
      const resp = await fetch(updateUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          oem: oem,
          quantity: newQty
        })
      });

      const data = await resp.json();
      if (resp.ok && data.ok) {
        window.location.reload();
      } else {
        console.error("Update failed:", data.error);
      }
    } catch (err) {
      console.error("Network error:", err);
    }
  });
});


    //Remove btn
    document.querySelectorAll(".cart-remove-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const oem = btn.dataset.oem;

        const ok = confirm("Remove this item from your cart?");
        if (!ok) return;

        try {
          const resp = await fetch(removeUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ oem: oem })
          });

          const data = await resp.json();
          if (resp.ok && data.ok) {
            window.location.reload();
          } else {
            console.error("Remove failed:", data.error);
          }
        } catch (err) {
          console.error("Network error:", err);
        }
      });
    });
  </script>
</body>
</html>
